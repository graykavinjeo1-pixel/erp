<!doctype html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>KSSE ÏóÖÎ¨¥Í¥ÄÎ¶¨ (DB Ver)</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
    <style>
      :root {
        --primary-color: #0b2b4e;
        --accent-color: #ffd000;
        --bg-gray: #f4f7f6;
      }
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      body {
        font-family: "Segoe UI", sans-serif;
        background: var(--bg-gray);
        display: flex;
        height: 100vh;
        overflow: hidden;
      }

      .sidebar {
        width: 250px;
        background: var(--primary-color);
        color: white;
        padding: 25px;
        display: flex;
        flex-direction: column;
      }
      .nav-item {
        padding: 15px;
        margin-bottom: 5px;
        border-radius: 8px;
        cursor: pointer;
        color: #ccc;
        transition: 0.3s;
        list-style: none;
        display: flex;
        align-items: center;
        gap: 10px;
      }
      .nav-item.active {
        background: rgba(255, 255, 255, 0.1);
        color: white;
        font-weight: bold;
        border-left: 4px solid var(--accent-color);
      }

      .main-content {
        flex: 1;
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }
      header {
        padding: 15px 30px;
        background: white;
        display: flex;
        justify-content: space-between;
        align-items: center;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
      }
      .controls {
        display: flex;
        gap: 10px;
        align-items: center;
      }

      .board {
        display: flex;
        gap: 15px;
        padding: 20px;
        flex: 1;
        overflow-x: auto;
      }
      .category {
        flex: 1;
        min-width: 300px;
        background: #ebedef;
        border-radius: 10px;
        display: flex;
        flex-direction: column;
      }
      .category h2 {
        padding: 15px;
        font-size: 1.1rem;
        color: #333;
        display: flex;
        justify-content: space-between;
      }
      .event-list {
        padding: 10px;
        flex: 1;
        overflow-y: auto;
        min-height: 200px;
      }
      .category.drag-over {
        background-color: #d1d8e0;
        border: 2px dashed var(--primary-color);
      }

      .memo-card {
        background: white;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 10px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        cursor: pointer;
        border-left: 5px solid #ccc;
      }
      .memo-card.dragging {
        opacity: 0.5;
      }
      .user-tag {
        font-size: 0.75rem;
        background: #eee;
        padding: 2px 6px;
        border-radius: 4px;
        float: right;
        color: #555;
      }
      .feedback-box {
        margin-top: 8px;
        padding: 8px;
        background: #fff3cd;
        border: 1px solid #ffeeba;
        border-radius: 5px;
        font-size: 0.85rem;
        color: #856404;
      }

      .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        justify-content: center;
        align-items: center;
        z-index: 1000;
      }
      .modal-content {
        background: white;
        padding: 25px;
        border-radius: 10px;
        width: 400px;
      }
      .modal-content input,
      .modal-content textarea {
        width: 100%;
        margin-bottom: 10px;
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 5px;
      }
      .modal-footer {
        margin-top: 15px;
        display: flex;
        gap: 10px;
        justify-content: flex-end;
      }
      .btn {
        padding: 8px 15px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-weight: bold;
      }
      .btn-primary {
        background: var(--primary-color);
        color: white;
      }
      .btn-danger {
        background: #ff4757;
        color: white;
      }
    </style>
  </head>
  <body>
    <aside class="sidebar">
      <h2 style="color: var(--accent-color)">KSSE ERP</h2>
      <ul style="padding: 0">
        <li class="nav-item active"><i class="fas fa-clipboard-list"></i> ÏóÖÎ¨¥ ÌòÑÌô©</li>
        <li class="nav-item" onclick="window.open('https://www.ksse.kr/calendar_v5.html')"><i class="fas fa-calendar-alt"></i> Ïä§ÏºÄÏ§ÑÎü¨</li>
      </ul>
      <div style="margin-top: auto">
        <div id="currentUserDisplay" style="margin-bottom: 10px; font-size: 0.9rem"></div>
        <button id="logoutButton" class="btn" style="width: 100%; background: rgba(255, 255, 255, 0.2); color: white">Î°úÍ∑∏ÏïÑÏõÉ</button>
      </div>
    </aside>

    <main class="main-content">
      <header>
        <h1>ÏóÖÎ¨¥ ÌòÑÌô© (DB Ïó∞Îèô)</h1>
        <div class="controls">
          <select id="employeeFilter" style="display: none; padding: 8px">
            <option value="all">Ï†ÑÏ≤¥ ÏÇ¨Ïõê Î≥¥Í∏∞</option>
          </select>
          <div id="loginSection">
            <input type="text" id="loginIdInput" placeholder="ID ÏûÖÎ†•" />
            <button id="loginBtn" class="btn btn-primary">Ï†ëÏÜç</button>
          </div>
          <button id="addMemoBtn" class="btn" style="background: var(--accent-color); color: #0b2b4e; display: none">+ ÏÉà ÏóÖÎ¨¥</button>
        </div>
      </header>
      <div class="board">
        <div class="category" id="done">
          <h2>ÏôÑÎ£å <span class="count">0</span></h2>
          <div class="event-list" id="doneList"></div>
        </div>
        <div class="category" id="inProgress">
          <h2>ÏßÑÌñâÏ§ë <span class="count">0</span></h2>
          <div class="event-list" id="inProgressList"></div>
        </div>
        <div class="category" id="todo">
          <h2>Ìï† Ïùº <span class="count">0</span></h2>
          <div class="event-list" id="todoList"></div>
        </div>
      </div>
    </main>

    <div class="modal" id="memoModal">
      <div class="modal-content">
        <h3 id="modalTitle" style="margin-bottom: 15px">ÏóÖÎ¨¥ ÏûëÏÑ±</h3>
        <input type="text" id="mTitle" placeholder="ÏóÖÎ¨¥ Ï†úÎ™©" />
        <textarea id="mContent" rows="5" placeholder="ÏóÖÎ¨¥ ÎÇ¥Ïö©"></textarea>
        <input type="text" id="mAttach" placeholder="Ï≤®Î∂ÄÌååÏùº URL" />
        <div id="adminFeedbackArea" style="display: none"><textarea id="mFeedback" rows="2" placeholder="[Í¥ÄÎ¶¨ÏûêÏö©] ÌîºÎìúÎ∞± ÏûÖÎ†•"></textarea></div>
        <div class="modal-footer">
          <button id="deleteMemoBtn" class="btn btn-danger" style="display: none; margin-right: auto">ÏÇ≠Ï†ú</button>
          <button id="closeModalBtn" class="btn" style="background: #eee">Îã´Í∏∞</button>
          <button id="saveMemoBtn" class="btn btn-primary">Ï†ÄÏû•</button>
        </div>
      </div>
    </div>

    <script>
      // *** Ïó¨Í∏∞Í∞Ä Ï§ëÏöîÌï©ÎãàÎã§! Í≤ΩÎ°úÍ∞Ä ÎßûÎäîÏßÄ ÌôïÏù∏ÌïòÏÑ∏Ïöî ***
      // index.htmlÍ≥º api Ìè¥ÎçîÍ∞Ä Í∞ôÏùÄ ÏúÑÏπòÎùºÎ©¥ 'api/api.php'
      const API_URL = "api/api.php";

      let employeeId = localStorage.getItem("ksse_employeeId") || "";
      let currentEditingData = null;
      async function fetchColorCodes() {
        try {
          // ÎÇ¥ ÏÑúÎ≤Ñ(api.php)Ïóê ÏÉâÏÉÅ ÏöîÏ≤≠
          const resp = await fetch(`${API_URL}?action=getColors`);
          if (resp.ok) {
            colorCodes = await resp.json();
            console.log("ÏÉâÏÉÅ Î°úÎìú ÏÑ±Í≥µ:", colorCodes); // ÌôïÏù∏Ïö© Î°úÍ∑∏
          }
        } catch (e) {
          console.error("ÏÉâÏÉÅ Ï†ïÎ≥¥ Î°úÎî© Ïã§Ìå®", e);
        }
      }
      document.addEventListener("DOMContentLoaded", async () => {
        if (employeeId) {
          initSession();
          await fetchAndDisplay();
          await setupAdminFilter();
        }
        document.getElementById("loginBtn").addEventListener("click", login);
        document.getElementById("logoutButton").addEventListener("click", logout);
        document.getElementById("addMemoBtn").addEventListener("click", () => openModal());
        document.getElementById("closeModalBtn").addEventListener("click", closeModal);
        document.getElementById("saveMemoBtn").addEventListener("click", saveMemo);
        document.getElementById("deleteMemoBtn").addEventListener("click", deleteMemo);
      });

      function login() {
        const id = document.getElementById("loginIdInput").value.trim();
        if (id) {
          localStorage.setItem("ksse_employeeId", id);
          location.reload();
        }
      }
      function logout() {
        localStorage.removeItem("ksse_employeeId");
        location.reload();
      }

      function initSession() {
        document.getElementById("loginSection").style.display = "none";
        document.getElementById("addMemoBtn").style.display = "block";
        document.getElementById("currentUserDisplay").textContent = `Ï†ëÏÜçÏ§ë: ${employeeId}`;
      }

      async function fetchAndDisplay(filterUser = "all") {
        try {
          const resp = await fetch(API_URL);
          if (!resp.ok) throw new Error("ÏÑúÎ≤Ñ Ïó∞Í≤∞ Ïã§Ìå®");
          const data = await resp.json();
          const memos = data.values || [];

          const lists = { todo: document.getElementById("todoList"), inProgress: document.getElementById("inProgressList"), done: document.getElementById("doneList") };
          Object.values(lists).forEach((el) => (el.innerHTML = ""));

          memos.forEach((memo) => {
            const [uid, title, content, category, attach, feedback] = memo;
            if (filterUser !== "all" && uid !== filterUser) return;
            if (employeeId !== "admin" && employeeId !== "ksse" && uid !== employeeId) return;

            const card = document.createElement("div");
            card.className = "memo-card";
            card.draggable = true;
            card.dataset.json = JSON.stringify({ uid, title, content, category, attach, feedback });

            card.innerHTML = `<span class="user-tag">${uid}</span><h3>${title}</h3><p>${content.replace(/\n/g, "<br>")}</p>
                        ${attach ? `<a href="${attach}" target="_blank" style="color:#007bff; text-decoration:none; font-size:0.8rem;">üìé Ï≤®Î∂ÄÌååÏùº</a>` : ""}
                        ${feedback ? `<div class="feedback-box"><strong>ÌîºÎìúÎ∞±:</strong> ${feedback}</div>` : ""}`;

            card.onclick = () => openModal(memo);
            card.ondragstart = (e) => {
              card.classList.add("dragging");
              e.dataTransfer.setData("text/plain", card.dataset.json);
            };
            card.ondragend = () => card.classList.remove("dragging");
            if (lists[category]) lists[category].appendChild(card);
          });

          setupDropZones();
          updateCounts();
        } catch (e) {
          console.error("Load Error", e);
        }
      }

      function setupDropZones() {
        document.querySelectorAll(".event-list").forEach((zone) => {
          zone.ondragover = (e) => {
            e.preventDefault();
            zone.parentElement.classList.add("drag-over");
          };
          zone.ondragleave = () => zone.parentElement.classList.remove("drag-over");
          zone.ondrop = async (e) => {
            e.preventDefault();
            zone.parentElement.classList.remove("drag-over");
            const data = JSON.parse(e.dataTransfer.getData("text/plain"));
            const newCategory = zone.id.replace("List", "");
            await updateDataOnServer(data, newCategory);
          };
        });
      }

      async function updateDataOnServer(data, newCategory) {
        const params = new URLSearchParams({ userID: data.uid, Ï†úÎ™©: data.title, ÎÇ¥Ïö©: data.content, Ïπ¥ÌÖåÍ≥†Î¶¨: newCategory, Ï≤®Î∂ÄÌååÏùº: data.attach || "", ÌîºÎìúÎ∞±: data.feedback || "" });
        await fetch(`${API_URL}?${params.toString()}`);
        fetchAndDisplay();
      }

      function openModal(rowId = null, data = null) {
        currentEditingId = rowId;
        const modal = document.getElementById("memoModal");
        modal.style.display = "flex";

        const deleteBtn = document.getElementById("deleteMemoBtn");
        const titleInput = document.getElementById("mTitle");

        // --- [ÌîºÎìúÎ∞± Ï†úÏñ¥ Î°úÏßÅ Ï∂îÍ∞Ä] ---
        const fbArea = document.getElementById("adminFeedbackArea");
        const fbInput = document.getElementById("mFeedback");

        // 1. ÌîºÎìúÎ∞± ÏòÅÏó≠ÏùÑ Ìï≠ÏÉÅ Î≥¥Ïù¥Í≤å ÏÑ§Ï†ï (ÏÇ¨ÏõêÎèÑ ÎÇ¥Ïö©ÏùÑ Î¥êÏïº ÌïòÎØÄÎ°ú)
        fbArea.style.display = "block";

        // 2. Í¥ÄÎ¶¨Ïûê Í∂åÌïú ÌôïÏù∏ ('admin' ÎòêÎäî 'ksse')
        const isAdmin = employeeId === "admin" || employeeId === "ksse";

        // 3. Í∂åÌïúÏóê Îî∞Îùº ÏûÖÎ†• Í∞ÄÎä•/Î∂àÍ∞ÄÎä• ÏÑ§Ï†ï
        if (isAdmin) {
          fbInput.disabled = false; // Í¥ÄÎ¶¨ÏûêÎäî ÏûÖÎ†• Í∞ÄÎä•
          fbInput.placeholder = "[Í¥ÄÎ¶¨ÏûêÏö©] ÌîºÎìúÎ∞± ÏûÖÎ†•";
          fbInput.style.backgroundColor = "white"; // ÏûÖÎ†• Í∞ÄÎä• Ïãú Ìù∞ÏÉâ Î∞∞Í≤Ω
        } else {
          fbInput.disabled = true; // ÏÇ¨ÏõêÏùÄ ÏùΩÍ∏∞ Ï†ÑÏö©
          fbInput.placeholder = "Îì±Î°ùÎêú ÌîºÎìúÎ∞±Ïù¥ ÏóÜÏäµÎãàÎã§.";
          fbInput.style.backgroundColor = "#f0f0f0"; // ÏùΩÍ∏∞ Ï†ÑÏö© Ïãú ÌöåÏÉâ Î∞∞Í≤Ω
        }
        // ----------------------------

        if (data) {
          // [ÏàòÏ†ï Î™®Îìú]
          currentEditingData = { uid: data[0], title: data[1], content: data[2], category: data[3], attach: data[4], feedback: data[5] };
          document.getElementById("modalTitle").textContent = "ÏóÖÎ¨¥ ÏàòÏ†ï";
          titleInput.value = data[1];
          document.getElementById("mContent").value = data[2];
          document.getElementById("mAttach").value = data[4] || "";
          document.getElementById("mFeedback").value = data[5] || "";

          // ÏÇ≠Ï†ú Î≤ÑÌäº: Í¥ÄÎ¶¨Ïûê OR Î≥∏Ïù∏ Í∏ÄÏùº Îïå ÌëúÏãú
          if (isAdmin || employeeId === data[0]) {
            deleteBtn.style.display = "block";
          } else {
            deleteBtn.style.display = "none";
          }
        } else {
          // [Ïã†Í∑ú Îì±Î°ù Î™®Îìú]
          currentEditingData = null;
          document.getElementById("modalTitle").textContent = "ÏÉà ÏóÖÎ¨¥ Îì±Î°ù";
          titleInput.value = "";
          document.getElementById("mContent").value = "";
          document.getElementById("mAttach").value = "";
          document.getElementById("mFeedback").value = "";
          deleteBtn.style.display = "none";
        }
      }

      async function saveMemo() {
        const title = document.getElementById("mTitle").value.trim();
        const content = document.getElementById("mContent").value.trim();
        const category = currentEditingData ? currentEditingData.category : "todo";
        const writer = currentEditingData ? currentEditingData.uid : employeeId;
        if (!title) return alert("Ï†úÎ™©ÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî.");

        const params = new URLSearchParams({ userID: writer, Ï†úÎ™©: title, ÎÇ¥Ïö©: content, Ïπ¥ÌÖåÍ≥†Î¶¨: category, Ï≤®Î∂ÄÌååÏùº: document.getElementById("mAttach").value, ÌîºÎìúÎ∞±: document.getElementById("mFeedback").value });

        try {
          const resp = await fetch(`${API_URL}?${params.toString()}`);
          if (!resp.ok) {
            const err = await resp.json();
            alert("Ïò§Î•ò: " + err.message);
            return;
          }
          closeModal();
          fetchAndDisplay();
        } catch (e) {
          alert("ÌÜµÏã† Ïò§Î•ò Î∞úÏÉù");
        }
      }

      async function deleteMemo() {
        if (!confirm("Ï†ïÎßêÎ°ú ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?")) return;
        let params;
        if (currentEditingData.category === "done") {
          params = new URLSearchParams({ userID: currentEditingData.uid, Ï†úÎ™©: currentEditingData.title, ÎÇ¥Ïö©: currentEditingData.content, Ïπ¥ÌÖåÍ≥†Î¶¨: "delete" });
        } else {
          params = new URLSearchParams({ action: "delete", userID: currentEditingData.uid, Ï†úÎ™©: currentEditingData.title });
        }
        await fetch(`${API_URL}?${params.toString()}`);
        closeModal();
        fetchAndDisplay();
      }

      function closeModal() {
        document.getElementById("memoModal").style.display = "none";
      }
      function updateCounts() {
        document.querySelectorAll(".category").forEach((cat) => {
          cat.querySelector(".count").textContent = cat.querySelector(".event-list").children.length;
        });
      }

      async function setupAdminFilter() {
        if (employeeId === "admin" || employeeId === "ksse") {
          const filter = document.getElementById("employeeFilter");
          filter.style.display = "block";
          try {
            const resp = await fetch(`${API_URL}?action=getEmployees`);
            const employees = await resp.json();
            filter.innerHTML = '<option value="all">Ï†ÑÏ≤¥ ÏÇ¨Ïõê Î≥¥Í∏∞</option>' + employees.map((emp) => `<option value="${emp}">${emp}</option>`).join("");
            filter.onchange = (e) => fetchAndDisplay(e.target.value);
          } catch (e) {}
        }
      }
    </script>
  </body>
</html>
